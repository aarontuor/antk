

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>generic_model &mdash; antk 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="antk 1.0 documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> antk
          

          
            
            <img src="../_static/antlogo_cut_shrunk2.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API: ANT modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_line.html">Command Line Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_line.html#movie-lens-processing">Movie Lens Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">Models</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">antk</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>generic_model</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for generic_model</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="kn">as</span> <span class="nn">sps</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">antk.core</span> <span class="kn">import</span> <span class="n">loader</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="c1"># ============================================================================================</span>
<span class="c1"># ============================CONVENIENCE DICTIONARY==========================================</span>
<span class="c1"># ============================================================================================</span>
<span class="n">OPT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;adam&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">,</span>
       <span class="s1">&#39;ada&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdagradOptimizer</span><span class="p">,</span>
       <span class="s1">&#39;grad&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">GradientDescentOptimizer</span><span class="p">,</span>
       <span class="s1">&#39;mom&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">}</span>

<span class="c1"># ============================================================================================</span>
<span class="c1"># ============================GLOBAL MODULE FUNCTIONS=========================================</span>
<span class="c1"># ============================================================================================</span>
<div class="viewcode-block" id="get_feed_list"><a class="viewcode-back" href="../generic_model.html#generic_model.get_feed_list">[docs]</a><span class="k">def</span> <span class="nf">get_feed_list</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">placeholderdict</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param batch: A dataset object.</span>
<span class="sd">    :param placeholderdict: A dictionary where the keys match keys in batch, and the values are placeholder tensors</span>
<span class="sd">    :param supplement: A dictionary of numpy input matrices with keys corresponding to placeholders in placeholderdict, where the row size of the matrices do not correspond to the number of datapoints. For use with input data intended for `embedding_lookup`_.</span>
<span class="sd">    :param dropouts: Dropout tensors in graph.</span>
<span class="sd">    :param dropout_flag: Whether to use Dropout probabilities for feed forward.</span>
<span class="sd">    :return: A feed dictionary with keys of placeholder tensors and values of numpy matrices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ph</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">datadict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">datadict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">supplement</span><span class="p">:</span>
        <span class="n">datadict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">supplement</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">placeholderdict</span><span class="p">:</span>
        <span class="n">ph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placeholderdict</span><span class="p">[</span><span class="n">desc</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sps</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">]):</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">])</span> <span class="ow">is</span> <span class="n">loader</span><span class="o">.</span><span class="n">HotIndex</span><span class="p">:</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span><span class="o">.</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n\t</span><span class="s1">ph: </span><span class="si">%s</span><span class="se">\n\t</span><span class="s1">dt: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desc</span><span class="p">,</span>
                                              <span class="n">placeholderdict</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">(),</span>
                                              <span class="n">datadict</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">dropouts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;dropout_prob&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropouts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">dropouts</span><span class="p">:</span>
            <span class="n">ph</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">train</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">dt</span><span class="p">)}</span>
    <span class="n">bn_deciders</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;bn_deciders&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bn_deciders</span><span class="p">:</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">decider</span><span class="p">:[</span><span class="n">train</span><span class="p">]</span> <span class="k">for</span> <span class="n">decider</span> <span class="ow">in</span> <span class="n">bn_deciders</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">fd</span></div>

<div class="viewcode-block" id="parse_summary_val"><a class="viewcode-back" href="../generic_model.html#generic_model.parse_summary_val">[docs]</a><span class="k">def</span> <span class="nf">parse_summary_val</span><span class="p">(</span><span class="n">summary_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to parse numeric value from tf.scalar_summary</span>

<span class="sd">    :param summary_str: Return value from running session on tf.scalar_summary</span>
<span class="sd">    :return: A dictionary containing the numeric values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Summary</span><span class="p">()</span>
    <span class="n">summary_proto</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">summary_str</span><span class="p">)</span>
    <span class="n">summaries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">summary_proto</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">summaries</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">simple_value</span>
    <span class="k">return</span> <span class="n">summaries</span></div>

<span class="c1"># ============================================================================================</span>
<span class="c1"># ============================GENERIC MODEL CLASS=============================================</span>
<span class="c1"># ============================================================================================</span>
<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../generic_model.html#generic_model.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic model builder for training and predictions.</span>

<span class="sd">    :param objective: Loss function</span>
<span class="sd">    :param placeholderdict: A dictionary of placeholders</span>
<span class="sd">    :param maxbadcount: For early stopping</span>
<span class="sd">    :param momentum: The momentum for tf.MomentumOptimizer</span>
<span class="sd">    :param mb: The mini-batch size</span>
<span class="sd">    :param verbose: Whether to print dev error, and save_tensor evals</span>
<span class="sd">    :param epochs: maximum number of epochs to train for.</span>
<span class="sd">    :param learnrate: learnrate for gradient descent</span>
<span class="sd">    :param save: Save best model to *best_model_path*.</span>
<span class="sd">    :param opt: Optimization strategy. May be &#39;adam&#39;, &#39;ada&#39;, &#39;grad&#39;, &#39;momentum&#39;</span>
<span class="sd">    :param decay: Parameter for decaying learn rate.</span>
<span class="sd">    :param evaluate: Evaluation metric</span>
<span class="sd">    :param predictions: Predictions selected from feed forward pass.</span>
<span class="sd">    :param logdir: Where to put the tensorboard data.</span>
<span class="sd">    :param random_seed: Random seed for TensorFlow initializers.</span>
<span class="sd">    :param model_name: Name for model</span>
<span class="sd">    :param clip_gradients: The limit on gradient size. If 0.0 no clipping is performed.</span>
<span class="sd">    :param make_histograms: Whether or not to make histograms for model weights and activations</span>
<span class="sd">    :param best_model_path: File to save best model to during training.</span>
<span class="sd">    :param save_tensors: A hashmap of str:Tensor mappings. Tensors are evaluated during training. Evaluations of these tensors on best model are accessible via property :any:`evaluated_tensors`.</span>
<span class="sd">    :param tensorboard: Whether to make tensorboard histograms of weights and activations, and graphs of dev_error.</span>
<span class="sd">    :return: :any:`Model`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">placeholderdict</span><span class="p">,</span>
                 <span class="n">maxbadcount</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mb</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learnrate</span><span class="o">=</span><span class="mf">0.003</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;grad&#39;</span><span class="p">,</span>
                 <span class="n">decay</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">evaluate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">logdir</span><span class="o">=</span><span class="s1">&#39;log/&#39;</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">,</span>
                 <span class="n">clip_gradients</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">make_histograms</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">best_model_path</span><span class="o">=</span><span class="s1">&#39;/tmp/model.ckpt&#39;</span><span class="p">,</span>
                 <span class="n">save_tensors</span><span class="o">=</span><span class="p">{},</span> <span class="n">tensorboard</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">train_evaluate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;losses&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">+=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placeholderdict</span> <span class="o">=</span> <span class="n">placeholderdict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxbadcount</span> <span class="o">=</span> <span class="n">maxbadcount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb</span> <span class="o">=</span> <span class="n">mb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span> <span class="o">=</span> <span class="n">learnrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decay</span> <span class="o">=</span> <span class="n">decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span> <span class="o">=</span> <span class="n">evaluate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_evaluate</span> <span class="o">=</span> <span class="n">train_evaluate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_dev_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_gradients</span> <span class="o">=</span> <span class="n">clip_gradients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard</span> <span class="o">=</span> <span class="n">tensorboard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_histograms</span> <span class="o">=</span> <span class="n">make_histograms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_histograms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogram_summaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logdir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">logdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">logdir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_tensors</span> <span class="o">=</span> <span class="n">save_tensors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_best_completed_epochs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated_tensors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_eval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_spot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_spot</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ================================================================</span>
        <span class="c1"># ======================For tensorboard===========================</span>
        <span class="c1"># ================================================================</span>
        <span class="k">if</span> <span class="n">tensorboard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_summaries</span><span class="p">()</span>

        <span class="c1"># =============================================================================</span>
        <span class="c1"># ===================OPTIMIZATION STRATEGY=====================================</span>
        <span class="c1"># =============================================================================</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">OPT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">]</span>
        <span class="n">decay_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">decay_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decay</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">global_step</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1">#keeps track of the mini-batch iteration</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">decay_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">decay_rate</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">exponential_decay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mb</span><span class="p">,</span>
                                                   <span class="n">decay_step</span><span class="p">,</span> <span class="n">decay_rate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;learnrate_decay&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_gradients</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gradients</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_gradients</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients_norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_global_norm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_gradients</span><span class="p">)</span>
            <span class="n">grads_and_vars</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;mom&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads_and_vars</span><span class="p">,</span>
                                                                      <span class="n">global_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span>
                                                                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span><span class="p">)</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads_and_vars</span><span class="p">,</span>
                                                                       <span class="n">global_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span>
                                                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;mom&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
                                                               <span class="n">global_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_step</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learnrate</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span>
                                                                <span class="n">global_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>

        <span class="c1"># =============================================================================</span>
        <span class="c1"># ===================Initialize graph =====================================</span>
        <span class="c1"># =============================================================================</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">initialize_all_variables</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span> <span class="o">=</span> <span class="n">best_model_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">)</span>

    <span class="c1"># ======================================================================</span>
    <span class="c1"># ================Properites============================================</span>
    <span class="c1"># ======================================================================</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">placeholderdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Dictionary of model placeholders</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placeholderdict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_dev_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The best dev error reached during training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_dev_error</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">average_secs_per_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The average number of seconds to complete an epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_times</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evaluated_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A dictionary of evaluations on best model for tensors and keys specified by *save_tensors* argument to constructor.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated_tensors</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">completed_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of epochs completed during training (fractional)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">best_completed_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Number of epochs completed during at point of best dev eval during training (fractional)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_completed_epochs</span>

<div class="viewcode-block" id="Model.plot_train_dev_eval"><a class="viewcode-back" href="../generic_model.html#generic_model.Model.plot_train_dev_eval">[docs]</a>    <span class="k">def</span> <span class="nf">plot_train_dev_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure_file</span><span class="o">=</span><span class="s1">&#39;testfig.pdf&#39;</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev_spot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dev&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_spot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_eval</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figure_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.predict"><a class="viewcode-back" href="../generic_model.html#generic_model.Model.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param data:  :any:`DataSet` to make predictions from.</span>
<span class="sd">        :return: A set of predictions from feed forward defined by :any:`self.predictions`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">get_feed_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholderdict</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="n">supplement</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span>
                                <span class="n">feed_dict</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.eval"><a class="viewcode-back" href="../generic_model.html#generic_model.Model.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_in</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluation of model.</span>

<span class="sd">        :param data: :any:`DataSet` to evaluate on.</span>
<span class="sd">        :return: Result of evaluating on data for :any:`self.evaluate`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">get_feed_list</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholderdict</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="n">supplement</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.train"><a class="viewcode-back" href="../generic_model.html#generic_model.Model.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span>
              <span class="n">dev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">eval_schedule</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
              <span class="n">train_dev_eval_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param data: :any:`DataSet` to train on.</span>
<span class="sd">        :return: A trained :any:`Model`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">)</span>
        <span class="c1"># ========================================================</span>
        <span class="c1"># ===========Check data to see if dev eval================</span>
        <span class="c1"># ========================================================</span>
        <span class="k">if</span> <span class="n">eval_schedule</span> <span class="o">==</span> <span class="s1">&#39;epoch&#39;</span><span class="p">:</span>
            <span class="n">eval_schedule</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">num_examples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># ============================================================================================</span>
        <span class="c1"># =============================TRAINING=======================================================</span>
        <span class="c1"># ============================================================================================</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_eval_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">:</span> <span class="c1"># keeps track of the epoch iteration</span>
            <span class="c1"># ==============PER MINI-BATCH=====================================</span>

            <span class="n">newbatch</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">next_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mb</span><span class="p">)</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">get_feed_list</span><span class="p">(</span><span class="n">newbatch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholderdict</span><span class="p">,</span> <span class="n">supplement</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_step</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mb</span>
            <span class="n">train_eval_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mb</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">num_examples</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_evaluate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">train_eval_counter</span> <span class="o">&gt;=</span> <span class="n">train_dev_eval_factor</span><span class="o">*</span><span class="n">eval_schedule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_eval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">supplement</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_spot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_eval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Aborting training...train evaluates to nan.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;epoch: </span><span class="si">%f</span><span class="s2"> train eval: </span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_eval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">train_eval_counter</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">eval_schedule</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
                <span class="c1">#=================PER eval_schedule==================================</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_summaries</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">supplement</span><span class="p">)</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dev</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">supplement</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dev_spot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Aborting training...dev evaluates to nan.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;epoch: </span><span class="si">%f</span><span class="s2"> dev error: </span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">tname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_tensors</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated_tensors</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_tensors</span><span class="p">[</span><span class="n">tname</span><span class="p">],</span> <span class="n">dev</span><span class="p">,</span> <span class="n">supplement</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluated_tensors</span><span class="p">[</span><span class="n">tname</span><span class="p">]))</span>
                    <span class="c1"># ================Early Stopping====================================</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_dev_error</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_best_dev_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deverror</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_best_completed_epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxbadcount</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;badcount exceeded: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_badcount</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="c1"># ==================================================================</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


    <span class="c1"># ================================================================</span>
    <span class="c1"># ======================For tensorboard===========================</span>
    <span class="c1"># ================================================================</span>
    <span class="k">def</span> <span class="nf">_init_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_histograms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histogram_summaries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">histogram_summary</span><span class="p">,</span>
                                      <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">()],</span>
                                      <span class="n">tf</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">()))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">histogram_summaries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">histogram_summary</span><span class="p">,</span>
                                      <span class="p">[</span><span class="s1">&#39;normalization/&#39;</span><span class="o">+</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;normalized_activations&#39;</span><span class="p">)],</span>
                                      <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;normalized_activations&#39;</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">histogram_summaries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">histogram_summary</span><span class="p">,</span>
                                      <span class="p">[</span><span class="s1">&#39;activation/&#39;</span><span class="o">+</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;activation_layers&#39;</span><span class="p">)],</span>
                                      <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;activation_layers&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_summary</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">scalar_summary</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_error_summary</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">scalar_summary</span><span class="p">(</span><span class="s1">&#39;dev_error&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="n">summary_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span>
                                         <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H-%M-%S&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">SummaryWriter</span><span class="p">(</span><span class="n">summary_directory</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_graph_def</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_log_summaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">dev</span><span class="p">,</span> <span class="n">supplement</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">get_feed_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholderdict</span><span class="p">,</span> <span class="n">supplement</span><span class="o">=</span><span class="n">supplement</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_histograms</span><span class="p">:</span>
                <span class="n">sum_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">histogram_summaries</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">sum_str</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">)</span>
            <span class="n">loss_sum_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_summary</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">loss_sum_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
                <span class="n">dev_sum_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev_error_summary</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">dev_sum_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_epochs</span><span class="p">)</span></div>



</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Aaron Tuor.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>